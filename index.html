<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Password Vault</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 650px; margin: 40px auto; background:#f9f9f9; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
  h2 { text-align:center; }
  input, button { padding:8px; margin:4px; border-radius:6px; border:1px solid #ccc; }
  button { background:#007bff; color:white; border:none; cursor:pointer; }
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th, td { border:1px solid #ddd; padding:6px; }
  td button { background:#4caf50; }
</style>
</head>
<body>
<h2>üîê Password Vault</h2>

<div id="auth">
  <input id="repoUser" placeholder="GitHub Username"><br>
  <input id="repoName" placeholder="Repository Name"><br>
  <input id="token" type="password" placeholder="GitHub Token (for edit)"><br>
  <input id="master" type="password" placeholder="Master Password"><br>
  <button id="loadBtn">Load Vault</button>
</div>

<div id="vault" style="display:none">
  <table id="pwTable">
    <thead><tr><th>Site</th><th>Username</th><th>Password</th><th>Copy</th><th>Delete</th></tr></thead>
    <tbody></tbody>
  </table>
  <br>
  <input id="site" placeholder="Site">
  <input id="user" placeholder="Username">
  <input id="pass" placeholder="Password">
  <button id="addBtn">Add</button>
  <button id="saveBtn">üíæ Save to GitHub</button>
</div>

<script>
async function getKey(key){
  const enc = new TextEncoder();
  return crypto.subtle.importKey("raw", enc.encode(key), "AES-GCM", false, ["encrypt","decrypt"]);
}

async function encryptData(text,key){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const cryptoKey = await getKey(key);
  const encoded = new TextEncoder().encode(text);
  const encrypted = await crypto.subtle.encrypt({name:"AES-GCM",iv},cryptoKey,encoded);
  const data = new Uint8Array([...iv,...new Uint8Array(encrypted)]);
  return btoa(String.fromCharCode(...data));
}

async function decryptData(encryptedBase64,key){
  const data = Uint8Array.from(atob(encryptedBase64), c=>c.charCodeAt(0));
  const iv = data.slice(0,12);
  const enc = data.slice(12);
  const cryptoKey = await getKey(key);
  const dec = await crypto.subtle.decrypt({name:"AES-GCM",iv},cryptoKey,enc);
  return new TextDecoder().decode(dec);
}

let data = [];
let masterKey = "";
let repoUser = "", repoName = "", token = "";

async function loadVault(){
  repoUser = document.getElementById('repoUser').value.trim();
  repoName = document.getElementById('repoName').value.trim();
  token = document.getElementById('token').value.trim();
  masterKey = document.getElementById('master').value.trim();

  const res = await fetch(`https://raw.githubusercontent.com/${repoUser}/${repoName}/main/passwords.json`);
  const txt = await res.text();

  try {
    const json = await decryptData(txt, masterKey);
    data = JSON.parse(json);
  } catch(e) {
    alert("‚ùå Wrong master password or empty vault");
    data = [];
  }

  document.getElementById('auth').style.display='none';
  document.getElementById('vault').style.display='block';
  render();
}

function render(){
  const body = document.querySelector('#pwTable tbody');
  body.innerHTML = '';
  data.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.site}</td><td>${p.username}</td><td>${p.password}</td>
                    <td><button onclick="navigator.clipboard.writeText('${p.password}')">Copy</button></td>
                    <td><button onclick="removeItem(${i})">X</button></td>`;
    body.appendChild(tr);
  });
}

window.removeItem = function(i){ data.splice(i,1); render(); }

document.getElementById('addBtn').onclick = ()=>{
  const s = site.value.trim(), u = user.value.trim(), p = pass.value.trim();
  if(!s||!p){ alert('Fill all fields'); return; }
  data.push({site:s,username:u,password:p});
  site.value=user.value=pass.value='';
  render();
};

document.getElementById('saveBtn').onclick = async ()=>{
  const enc = await encryptData(JSON.stringify(data), masterKey);
  const b64 = btoa(unescape(encodeURIComponent(enc)));
  const file = new Blob([enc], {type:'text/plain'});

  // Push update to GitHub
  const getRes = await fetch(`https://api.github.com/repos/${repoUser}/${repoName}/contents/passwords.json`);
  const fileData = await getRes.json().catch(()=>({}));
  const sha = fileData.sha;

  const res = await fetch(`https://api.github.com/repos/${repoUser}/${repoName}/contents/passwords.json`, {
    method:'PUT',
    headers:{
      "Authorization":`token ${token}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      message:"update passwords",
      content:btoa(enc),
      sha:sha
    })
  });
  if(res.ok){ alert('‚úÖ Saved to GitHub!'); }
  else alert('‚ùå Failed to save');
};

document.getElementById('loadBtn').onclick = loadVault;
</script>
</body>
</html>
